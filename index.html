<!DOCTYPE html>
<html lang="en" dir="ltr">

<head>
  <meta charset="utf-8">
  <title></title>
  <link rel='stylesheet' href='Styles/style.css' />
  <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
  <!-- <script src="https://code.jquery.com/jquery-3.2.1.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script> -->
  <script src="Scripts/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/luxon@2.0.2/build/global/luxon.min.js"></script>
</head>

<body>
  <h1 class="centre">Taxing 212</h1>
  <h5 class="centre">A UK capital gains tax calculator for Trading 212</h5>
  <!--
  <input id="csv" type="file">

  <output id="out">
      file contents will appear here
  </output> -->

  <div id="app">


    <div v-if="!calculated">
      <div style="height:60px"></div>
      <div style="margin:0 40px">
        <div class="instruction">
          <h3>Step 1</h3>
          <p>Load your T212 trade history CSV files. Full history is required to
            calculate Section 104 Holdings prices. If history is spread across multiple files please ensure there are no
            overlaps.</p>
          <div v-if="fileList.length > 0" class="files">
            <strong>Files Loaded:</strong>
            <template v-for="i in fileList">
              <p>{{fileList[0]}}</p>
            </template>
          </div>
          <input id="fileButton" style="display:none" type="file" ref="csvFile" @change="addFile"></input><br>
          <input type="button" value="Add CSV File" onclick="document.getElementById('fileButton').click();" />
          <input type="Button" name="" value="Clear Files" v-on:click="clearFiles()">
          <p>Note: If you have made changes to a csv file it must be removed and re-added.</p>
        </div>
        <div class="instruction">
          <h3>Step 2</h3>
          <p>Select Tax Year to report on</p>
          <h4>Tax Year starting <input type="number" v-model="taxYear.target"></input> , {{fyText}} </h4>
        </div>
        <div class="instruction">
          <h3>Step 3</h3>
          <p>Hit Calculate</p>
          <h1 v-if="calculating"> Calculating...</h1>
          <button v-on:click="calculate()">Calculate</button>
        </div>
      </div>
    </div>


    <div v-if="calculated">
      <button v-on:click="back()">
        < Back to File and Tax Year Selection</button> <h2 class="centre">Calculations for {{fyText}}</h2>



          <div class="error-container" v-if="errorList.length > 0">
            <h2 class="summary-box-title">Errors Detected:</h2>
            <p>Errors were found during calculations - normally caused by missing data or tickers changing (i.e. for SPACs). Fix or understand these before
              proceeding.</p>
            <template v-for="error in errorList">
              <div class="error">
                {{error.msg}}
                <span v-if="Number(error.linkedUid)">(GoTo:<span v-html="getIdLink(error.linkedUid)"></span>)</span>
              </div>
            </template>
          </div>

          <div class="summary-master-container">
            <div class="summary-container g2">
              <h2 class="summary-box-title"> All Data Summary: </h2>
              <div class="summary-item c1">
                Disposal Count:
              </div>
              <div class="summary-item c2">
                {{disposalCount}}
              </div>
              <div class="summary-item c1">
                Total Realised Profit:
              </div>
              <div class="summary-item c2">
                £{{realisedProfit.toFixed(2)}}
              </div>
              <div class="summary-item c1">
                Total Realised Loss:
              </div>
              <div class="summary-item c2">
                £{{realisedLoss.toFixed(2)}}
              </div>
              <div class="summary-item c1">
                Combined P/L:
              </div>
              <div class="summary-item c2">
                £{{(realisedProfit - realisedLoss).toFixed(2)}}
              </div>
              <div class="summary-item c1">
                Dividends Received:
              </div>
              <div class="summary-item c2">
                £{{dividendsTotal.toFixed(2)}}
              </div>
            </div>

            <div class="summary-container g2">
              <h2 class="summary-box-title"> Tax Year {{fyText}} Summary: </h2>
              <div class="summary-item c1">
                Disposal Count:
              </div>
              <div class="summary-item c2">
                {{taxYearData.disposals}}
              </div>
              <div class="summary-item c1">
                Disposal Proceeds:
              </div>
              <div class="summary-item c2">
                £{{taxYearData.proceeds.toFixed(2)}}
              </div>
              <div class="summary-item c1">
                Total acquisition costs:
              </div>
              <div class="summary-item c2">
                £{{taxYearData.costs.toFixed(2)}}
              </div>
              <div class="summary-item c1">
                Total Realised Profit:
              </div>
              <div class="summary-item c2">
                £{{taxYearData.realisedProfit.toFixed(2)}}
              </div>
              <div class="summary-item c1">
                Total Realised Loss:
              </div>
              <div class="summary-item c2">
                £{{taxYearData.realisedLoss.toFixed(2)}}
              </div>
              <div class="summary-item c1">
                Combined P/L:
              </div>
              <div class="summary-item c2">
                £{{(taxYearData.realisedProfit - taxYearData.realisedLoss).toFixed(2)}}
              </div>
              <div class="summary-item c1">
                Dividends Received:
              </div>
              <div class="summary-item c2">
                £{{taxYearData.dividends.toFixed(2)}}
              </div>
            </div>

            <div class="summary-container g2">
              <h2 class="summary-box-title"> Deposits </h2>
              <template v-for="dep in deposits">
                <div class="summary-item c1">
                  {{getDmyString(dep.timestamp)}}
                </div>
                <div class="summary-item c2">
                  £{{dep.value}}
                </div>

              </template>
            </div>

            <div class="summary-container g2">
              <h2 class="summary-box-title"> Withdrawals </h2>
              <template v-for="itm in withdrawals">
                <div class="summary-item c1">
                  {{getDmyString(itm.timestamp)}}
                </div>
                <div class="summary-item c2">
                  £{{itm.value}}
                </div>
              </template>
            </div>
          </div>

          <div class="summary-master-container">
            <div v-if="dividends.length" class="dividends-container g4">
              <h2 class="summary-box-title"> Dividends </h2>
              <h4 class="summary-box-subheading">Tax Year Dividends Summary</h4>
              <h5 class="c1">
                Uk Companies Total
              </h5>
              <h5 class="c2">
                Uk Other (Funds/Trusts) Total
              </h5>
              <h5 class="c3">
                Foreign Total
              </h5>
              <h5 class="c4">
                Foreign Taxes Paid
              </h5>
              <div class="c1">
                £{{divTyUkC}}
              </div>
              <div class="c2">
                £{{divTyUkO}}
              </div>
              <div class="c3">
                £{{dividendDetails.nonUk.toFixed(2)}}
              </div>
              <div class="c4">
                £{{dividendDetails.taxPaid.toFixed(2)}}
              </div>
              <h4 class="summary-box-subheading">Uk Company Dividends</h4>
              <h5 class="c1">
                Date Received
              </h5>
              <h5 class="c2">
                Name
              </h5>
              <h5 class="c3">
                Value
              </h5>
              <h5 class="c4">
                UK Company?
              </h5>
              <template v-for="itm in dividends">
                <!-- <div v-if="itm.isUk && itm.ukCompany"> -->
                <div v-if="itm.isUk && itm.ukCompany" class="summary-item c1">
                  {{getDmyString(itm.timestamp)}} <span v-if="itm.inTaxYear">*</span>
                </div>
                <div v-if="itm.isUk && itm.ukCompany" class="summary-item c2">
                  {{itm.name}}({{itm.ticker}})
                </div>
                <div v-if="itm.isUk && itm.ukCompany" class="summary-item c3">
                  £{{itm.value}}
                </div>
                <div v-if="itm.isUk && itm.ukCompany" class="summary-item c4">
                  <input type="checkbox" id="checkbox" v-model="itm.ukCompany">
                </div>
                <!-- </div> -->
              </template>
              <h4 class="summary-box-subheading">Other UK Dividends</h4>
              <h5 class="c1">
                Date Received
              </h5>
              <h5 class="c2">
                Name
              </h5>
              <h5 class="c3">
                Value
              </h5>
              <h5 class="c4">
                UK Company?
              </h5>
              <template v-for="itm in dividends">

                <div v-if="itm.isUk && !itm.ukCompany" class="summary-item c1">
                  {{getDmyString(itm.timestamp)}} <span v-if="itm.inTaxYear">*</span>
                </div>
                <div v-if="itm.isUk && !itm.ukCompany" class="summary-item c2">
                  {{itm.name}}({{itm.ticker}})
                </div>
                <div v-if="itm.isUk && !itm.ukCompany" class="summary-item c3">
                  £{{itm.value}}
                </div>
                <div v-if="itm.isUk && !itm.ukCompany" class="summary-item c4">
                  <input type="checkbox" id="checkbox" v-model="itm.ukCompany">
                </div>

              </template>
              <h4 class="summary-box-subheading">Non-UK Dividends</h4>
              <h5 class="c1">
                Date Received
              </h5>
              <h5 class="c2">
                Name
              </h5>
              <h5 class="c3">
                Value
              </h5>
              <h5 class="c4">
                Tax Paid
              </h5>
              <template v-for="itm in dividends">

                <div v-if="!itm.isUk" class="summary-item c1">
                  {{getDmyString(itm.timestamp)}} <span v-if="itm.inTaxYear">*</span>
                </div>
                <div v-if="!itm.isUk" class="summary-item c2">
                  {{itm.name}}({{itm.ticker}})
                </div>
                <div v-if="!itm.isUk" class="summary-item c3">
                  £{{itm.value}}
                </div>
                <div v-if="!itm.isUk" class="summary-item c4">
                  £{{itm.taxPaidGBP.toFixed(2)}}
                </div>

              </template>
            </div>
            <p>* in Tax Year {{fyText}}</p>
          </div>


          <div class="holding">
            <h2 class="section-title">{{fyText}} Round Trips</h2>
            <div class="round-trip-container">
              <h5 class="ledger-entry c1">Date Sold</h5>
              <h5 class="ledger-entry c2">Date Aquired</h5>
              <h5 class="ledger-entry c3">Asset</h5>
              <h5 class="ledger-entry c4">Amount</h5>
              <h5 class="ledger-entry c5">Cost £</h5>
              <h5 class="ledger-entry c6">Proceeds £</h5>
              <h5 class="ledger-entry c7">P/L £</h5>
              <h5 class="ledger-entry c8">Notes</h5>
              <template v-for="t in taxYearData.roundTrips">
                <div class="trade-row">
                  <span v-bind:class="getTradeClass(t.gainLoss)" class="ledger-entry c1">{{t.dateSold}}</span>
                  <span v-bind:class="getTradeClass(t.gainLoss)" class="ledger-entry c2">{{t.dateBought}}</span>
                  <span v-bind:class="getTradeClass(t.gainLoss)" class="ledger-entry c3">{{t.asset}}</span>
                  <span v-bind:class="getTradeClass(t.gainLoss)" class="ledger-entry c4">{{t.amount.toFixed(2)}}</span>
                  <span v-bind:class="getTradeClass(t.gainLoss)" class="ledger-entry c5">{{t.cost}}</span>
                  <span v-bind:class="getTradeClass(t.gainLoss)" class="ledger-entry c6">{{t.proceeds}}</span>
                  <span v-bind:class="getTradeClass(t.gainLoss)" class="ledger-entry c7">{{t.gainLoss}}</span>
                  <span v-bind:class="getTradeClass(t.gainLoss)" class="ledger-entry c8">{{t.note}}</span>
                </div>
              </template>
            </div>
            <div class="download-button" v-on:click="downloadRoundTrips()">Download RoundTrip CSV for {{fyText}}</div>
          </div>

          <div style="height: 100px"></div>

          <h2 class="section-title"> Holdings: </h2>
          <template v-for="inst in holdings">
            <div class="holding">
              <div class="holding-title"><strong>{{inst.name}} ({{inst.ticker}})</strong></div>
              <p>All Time - Holdings: {{inst.holdings.toFixed(2)}},
                Disposals: £{{inst.disposalCount}},
                P/L: £{{inst.realisedPl.toFixed(2)}}</p>
              <p>Tax Year - Disposals:{{inst.tyData.disposalCount}},
                Gain: £{{inst.tyData.realisedProfit.toFixed(2)}},
                Loss: £{{inst.tyData.realisedLoss.toFixed(2)}},
                P/L: £{{(inst.tyData.realisedProfit - inst.tyData.realisedLoss).toFixed(2)}}</p>
              <h4>Trades:</h4>
              <div class="disposal-container">
                <!-- Number of Trades: {{inst.trades.length}} -->
                <h5 class="ledger-entry c1">ID</h5>
                <h5 class="ledger-entry c2">Date</h5>
                <h5 class="ledger-entry c3">Type</h5>
                <h5 class="ledger-entry c4"># Shares</h5>
                <h5 class="ledger-entry c5">Price GBP</h5>
                <h5 class="ledger-entry c6">Total GBP</h5>
                <template v-for="t,key in inst.trades">
                  <!-- {{JSON.stringify(t)}}€€ -->
                  <div v-bind:class="getTradeClass(t.rawType)" class="trade-row">
                    <span v-bind:class="getTradeClass(t.rawType)" class="ledger-entry c1">{{t.uid}}</span>
                    <span v-bind:class="getTradeClass(t.rawType)" class="ledger-entry c2">{{getDmyString(t.timestamp)}}</span>
                    <span v-bind:class="getTradeClass(t.rawType)" class="ledger-entry c3">{{t.rawType}}</span>
                    <span v-bind:class="getTradeClass(t.rawType)" class="ledger-entry c4">{{t.number}}</span>
                    <span v-bind:class="getTradeClass(t.rawType)" class="ledger-entry c5">{{t.priceGBP.toFixed(2)}}</span>
                    <span v-bind:class="getTradeClass(t.rawType)" class="ledger-entry c6">{{t.total.toFixed(2)}}</span>
                  </div>
                </template>
              </div>
              <h4>Ledger:</h4>
              <div class="disposal-container">
                <!-- Ledger Length: {{inst.ledger.length}} -->
                <!-- titles -->
                <!-- <div class="trade-row"> -->
                <h5 class="ledger-entry ledger-uid">ID</h5>
                <h5 class="ledger-entry ledger-date">Date</h5>
                <h5 class="ledger-entry ledger-change">Change</h5>
                <h5 class="ledger-entry ledger-price">Price £</h5>
                <h5 class="ledger-entry ledger-gain">Gain £</h5>
                <h5 class="ledger-entry ledger-loss">Loss £</h5>
                <h5 class="ledger-entry ledger-s104t">S104 Holdings</h5>
                <h5 class="ledger-entry ledger-s104p">S104 Price</h5>
                <h5 class="ledger-entry ledger-comment">Comment</h5>
                <!-- </div> -->
                <template v-for="d in inst.ledger">
                  <!-- {{JSON.stringify(d)}} -->
                  <!-- <div v-bind:class="getTradeClass(d.change)" class="trade-row"> -->
                  <span v-bind:class="getTradeClass(d.change)" v-bind:id="d.uid" class="ledger-entry ledger-uid">{{d.uid}}</span>
                  <span v-bind:class="getTradeClass(d.change)" class="ledger-entry ledger-date">{{getDmyString(d.timestamp)}}</span>
                  <span v-bind:class="getTradeClass(d.change)" class="ledger-entry ledger-change">{{d.change.toFixed(2)}}</span>
                  <span v-bind:class="getTradeClass(d.change)" class="ledger-entry ledger-price">{{d.price.toFixed(2)}}</span>
                  <span v-bind:class="getTradeClass(d.change)" class="ledger-entry ledger-gain">{{d.gain.toFixed(2)}}</span>
                  <span v-bind:class="getTradeClass(d.change)" class="ledger-entry ledger-loss">{{d.loss.toFixed(2)}}</span>
                  <span v-bind:class="getTradeClass(d.change)" class="ledger-entry ledger-s104t">{{d.s104Total.toFixed(2)}}</span>
                  <span v-bind:class="getTradeClass(d.change)" class="ledger-entry ledger-s104p">{{d.s104Price.toFixed(2)}}</span>
                  <span v-bind:class="getTradeClass(d.change)" class="ledger-entry ledger-comment">
                    <template v-for="comm in d.comment">
                      <p>{{comm}}</p>
                    </template>
                  </span>
                  <!-- </div> -->
                </template>
              </div>
              <div class="position-status-container"></div>
            </div>
          </template>




    </div>
  </div>

  <div style="height:100px"></div>
  <div style="margin:0 40px">
    <p>This tool is a work in progress and the results are assumed to be inaccurate.</p>
    <p>DISCLAIMER: THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
      IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
      FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
      AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
      LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
      OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
      SOFTWARE.</p>
  </div>
</body>

</html>
<script type='text/javascript' src="Scripts/script.js"></script>